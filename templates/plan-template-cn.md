# 实施方案：[功能名称]

**分支**：`[###-feature-name]` | **日期**：[DATE] | **规范**：[link]  
**输入**：功能规格文件 `/specs/[###-feature-name]/spec.md`

## 执行流程（/plan 命令范围）
```
1. 从输入路径加载功能规范
   → 若未找到：报错 "No feature spec at {path}"
2. 填充技术上下文（扫描 NEEDS CLARIFICATION）
   → 根据上下文检测项目类型（web=前端+后端，mobile=app+api）
   → 根据项目类型确定结构决策
3. 检查宪章合规性（见下文 Constitution Check）
   → 若存在违规：记录于复杂度追踪
   → 若无法合理解释：报错 "Simplify approach first"
   → 更新进度追踪：初步宪章检查
4. 执行第0阶段 → research.md
   → 若仍有 NEEDS CLARIFICATION：报错 "Resolve unknowns"
5. 执行第1阶段 → contracts、data-model.md、quickstart.md、特定代理模板文件（如 `CLAUDE.md`、`.github/copilot-instructions.md`、`GEMINI.md`）
6. 再次检查宪章合规性
   → 若有新违规：重构设计，返回第1阶段
   → 更新进度追踪：设计后宪章检查
7. 规划第2阶段 → 描述任务生成方法（不创建 tasks.md）
8. 停止 - 等待 /tasks 命令
```

**重要说明**：/plan 命令仅执行到第7步。第2-4阶段由其他命令完成：
- 第2阶段：/tasks 命令生成 tasks.md
- 第3-4阶段：手动或工具辅助实施

## 摘要
[从功能规范中提取：主要需求 + 技术方案（来自 research）]

## 技术上下文
**语言/版本**：[如 Python 3.11、Swift 5.9、Rust 1.75 或需补充]  
**主要依赖**：[如 FastAPI、UIKit、LLVM 或需补充]  
**存储**：[如 PostgreSQL、CoreData、文件或不适用]  
**测试**：[如 pytest、XCTest、cargo test 或需补充]  
**目标平台**：[如 Linux 服务器、iOS 15+、WASM 或需补充]  
**项目类型**：[单体/web/mobile - 决定源码结构]  
**性能目标**：[领域相关，如 1000 req/s、1万行/秒、60 fps 或需补充]  
**约束条件**：[领域相关，如 p95<200ms、内存<100MB、支持离线或需补充]  
**规模/范围**：[领域相关，如 1万用户、百万行代码、50个界面或需补充]

## 宪章合规性检查
*门槛：必须通过后方可进入第0阶段研究。第1阶段设计后需再次检查。*

**简洁性**：
- 项目数：[#]（最多3个，如 api、cli、tests）
- 是否直接使用框架？（无额外封装类）
- 单一数据模型？（除非序列化需求不同，不引入DTO）
- 是否避免设计模式？（无特殊需求不引入 Repository/UoW 等）

**架构**：
- 每个功能均为库？（无直接 app 代码）
- 库清单：[每个库名称+用途]
- 每个库有 CLI？（含 --help/--version/--format）
- 库文档：llms.txt 格式是否规划？

**测试（强制要求）**：
- 是否严格执行 RED-GREEN-Refactor 流程？（测试必须先失败）
- Git 提交顺序：先有测试再有实现？
- 顺序：契约→集成→端到端→单元测试严格依次？
- 是否使用真实依赖？（实际数据库，非 mock）
- 集成测试覆盖：新库、契约变更、共享 schema？
- 禁止：先实现后测试，跳过 RED 阶段

**可观测性**：
- 是否包含结构化日志？
- 前端日志是否汇总到后端？（统一日志流）
- 错误上下文是否充分？

**版本管理**：
- 是否分配版本号？（主.次.构建号）
- 每次变更构建号递增？
- 破坏性变更如何处理？（并行测试、迁移方案）

## 项目结构

### 文档结构（本功能相关）
```
specs/[###-feature]/
├── plan.md              # 本文件（/plan 命令输出）
├── research.md          # 阶段0输出（/plan 命令）
├── data-model.md        # 阶段1输出（/plan 命令）
├── quickstart.md        # 阶段1输出（/plan 命令）
├── contracts/           # 阶段1输出（/plan 命令）
└── tasks.md             # 阶段2输出（/tasks 命令，非 /plan 生成）
```

### 源代码结构（仓库根目录）
```
# 方案一：单项目（默认）
src/
├── models/
├── services/
├── cli/
└── lib/

tests/
├── contract/
├── integration/
└── unit/

# 方案二：Web 应用（检测到“frontend”+“backend”时）
backend/
├── src/
│   ├── models/
│   ├── services/
│   └── api/
└── tests/

frontend/
├── src/
│   ├── components/
│   ├── pages/
│   └── services/
└── tests/

# 方案三：移动端 + API（检测到“iOS/Android”时）
api/
└── [同 backend 结构]

ios/ 或 android/
└── [平台相关结构]
```

**结构选择**：除非技术背景明确为 Web/移动端应用，否则默认采用方案一。

## 阶段0：梳理与调研
1. **从技术背景中提取未知点**：
   - 每个需要澄清的问题 → 调研任务
   - 每个依赖项 → 最佳实践任务
   - 每个集成需求 → 模式研究任务

2. **生成并分派调研任务**：
   ```
   针对技术背景中的每个未知点：
     任务：“调研 {unknown} 在 {feature context} 下的应用”
   针对每项技术选型：
     任务：“查找 {domain} 领域内 {tech} 的最佳实践”
   ```

3. **在 `research.md` 中汇总调研结论**，格式如下：
   - 决策：[最终选择]
   - 理由：[选择原因]
   - 备选方案：[曾考虑的其他选项]

**输出**：research.md，所有需澄清点均已解决

## 阶段1：设计与契约
*前提：research.md 已完成*

1. **从功能规格中提取实体**，写入 `data-model.md`：
   - 实体名称、字段、关系
   - 需求中的校验规则
   - 如有状态流转，需补充说明

2. **根据功能需求生成 API 契约**：
   - 每个用户操作对应一个接口
   - 采用标准 REST/GraphQL 设计模式
   - 输出 OpenAPI/GraphQL schema 至 `/contracts/`

3. **根据契约生成契约测试**：
   - 每个接口生成一个测试文件
   - 校验请求/响应数据结构
   - 测试初始均为失败（尚无实现）

4. **从用户故事中提取测试场景**：
   - 每个故事对应一个集成测试场景
   - 快速上手测试即为故事验证步骤

5. **增量更新 agent 文件**（O(1) 操作）：
   - 运行 `/scripts/update-agent-context.sh [claude|gemini|copilot]`，为你的 AI 助手更新上下文
   - 如已存在，仅添加本次计划中新出现的技术
   - 保留标记间的人工补充内容
   - 更新最近变更（保留最近3条）
   - 控制在150行以内，提升 token 效率
   - 输出至仓库根目录

**输出**：data-model.md、/contracts/*、失败的测试用例、quickstart.md、agent 专用文件

## 阶段2：任务规划方法
*本节描述 /tasks 命令的执行方式——/plan 阶段无需执行*

**任务生成策略**：
- 以 `/templates/tasks-template.md` 为基础
- 根据阶段1设计文档（契约、数据模型、quickstart）生成任务
- 每个契约 → 契约测试任务 [P]
- 每个实体 → 模型创建任务 [P]
- 每个用户故事 → 集成测试任务
- 生成实现任务，使测试通过

**任务排序策略**：
- TDD顺序：先写测试，再做实现
- 依赖顺序：先建模型，再做服务，最后开发UI
- 标记[P]表示可并行执行（文件间无依赖）

**预计产出**：在tasks.md中列出25-30条有编号、排序的任务

**重要提示**：本阶段由/tasks命令执行，不能用/plan命令

## 第3+阶段：后续实现
*这些阶段超出/plan命令的范围*

**第3阶段**：任务执行（/tasks命令生成tasks.md）  
**第4阶段**：实现（按宪法原则执行tasks.md中的任务）  
**第5阶段**：验证（运行测试，执行quickstart.md，性能验证）

## 复杂度追踪
*仅当宪法检查有违规且必须说明理由时填写*

| 违规项 | 必要原因 | 拒绝更简单方案的理由 |
|--------|----------|----------------------|
| [如：第4个项目] | [当前需求] | [为何3个项目不够] |
| [如：仓储模式] | [具体问题] | [为何直接访问数据库不行] |


## 进度追踪
*此清单在执行流程中持续更新*

**阶段状态**：
- [ ] 第0阶段：调研完成（/plan命令）
- [ ] 第1阶段：设计完成（/plan命令）
- [ ] 第2阶段：任务规划完成（/plan命令，仅描述方法）
- [ ] 第3阶段：任务生成（/tasks命令）
- [ ] 第4阶段：实现完成
- [ ] 第5阶段：验证通过

**门控状态**：
- [ ] 初始宪法检查：通过
- [ ] 设计后宪法检查：通过
- [ ] 所有“需澄清”问题已解决
- [ ] 复杂度偏差已记录

---
*基于宪法v2.1.1——详见`/memory/constitution.md`*